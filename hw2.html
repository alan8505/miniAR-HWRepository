<!DOCTYPE html>
<head>
<script src="https://alan8505.github.io/miniAR-HWRepository/three.js/three.min.js"></script>
<script src="https://alan8505.github.io/miniAR-HWRepository/three.js/ar.js"></script>
<script src="https://threejs.org/examples/js/libs/stats.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>

<body>
<style>
#things{
  position: absolute;
  top: 2%;
  width: 100%;
  padding: 10px;
  text-align: center;
  z-index: 2;
  color: #ffffff;
}

.info{
  color: rgb(0, 0, 0);
  border-width: 3px;
  width: 150px;
  height: 30px;
  padding: 5px;
  text-align: center;
  background-color: rgb(200, 200, 200, 0.7);
  border-radius: 4px;
}

#text{
  color: rgb(0, 0, 0);
  border-width: 3px;
  width: 150px;
  height: 30px;
  padding: 5px;
  text-align: center;
  background-color: rgb(200, 200, 200, 0.7);
  border-radius: 4px;
}

body {
  overflow: hidden;
}
</style>
	
<div id="things">
  <span class="info">桌子：37.2x47.3cm</span><br><br>
  <span class="info">Marker：8.3x8.3cm</span><br><br>
  <button id="button1">Start</button><br><br>
  <span id="text">color</span>
</div>
	
<script>
// global variables
var renderer, scene, camera, clock, control, stats;
var arToolKitSource, arToolKitContext, markerHiro;

var disc, cone;
var angle = 0, omega = 0;
var isTurning = false;

var markerSize = 8.3;
var tableSize = 37.2;
var radius = tableSize/markerSize/2;

var arMode = true;

init();
animate();

//return;

function init() {

	// init renderer
	renderer = new THREE.WebGLRenderer( {alpha: true} );
	renderer.setSize( window.innerWidth, window.innerHeight );
	renderer.domElement.style.position = 'absolute';
	renderer.domElement.style.top = '0px';
	renderer.domElement.style.left = '0px';
	document.body.appendChild( renderer.domElement );

	stats = new Stats();
	document.body.appendChild( stats.domElement );

	clock = new THREE.Clock();
	scene	= new THREE.Scene();
	
	// create camera and control for test mode
  if (!arMode) {
  	
    camera = new THREE.PerspectiveCamera (45,  window.innerWidth/window.innerHeight, 0.1, 10000);
    camera.position.y = 5;
    camera.position.z = 5;
    camera.lookAt (new THREE.Vector3(0,0,0));
    controls = new THREE.OrbitControls( camera, renderer.domElement );
  	controls.update();
    
  }

  if (arMode) {
  
  	// create basic camera for AR
  	camera = new THREE.Camera();
		scene.add(camera);
  
  	// handle arToolkitSource
  	arToolkitSource = new THREEx.ArToolkitSource( {sourceType : 'webcam'} );

    arToolkitSource.init(function onReady() {
      onResize();
    });

    // handle resize
    window.addEventListener('resize', function() {
      onResize();
    });
    

    // initialize arToolkitContext 
    arToolkitContext = new THREEx.ArToolkitContext( {
    
      cameraParametersUrl: 'https://jyunming-chen.github.io/ar.js/data/data/camera_para.dat',
      detectionMode: 'mono',
      maxDetectionRate: 30,
      
    });
    
    // initialize it
    
    arToolkitContext.init( function onCompleted() {
      // copy projection matrix to camera
      camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
    });
    

  }
  
  
  markerHiro = addMarkerHiro();
  scene.add(markerHiro);
  
  // add button onclick listener
  document.getElementById("button1").onclick = function() {
  
  	if (isTurning) {
    	this.innerHTML = "Start";
    }
    else {
    	this.innerHTML = "Stop";
    }
    
  	isTurning = !isTurning;
    
  };
  
}
	
function addMarkerHiro() {

	let markerRoot = new THREE.Group()
  var artoolkitMarker;
  if (arMode) {
  	artoolkitMarker = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
      type: 'pattern',
      patternUrl:  'https://jyunming-chen.github.io/ar.js/data/data/patt.hiro'
    });
  }
	

	// add things
  disc = new THREE.Group();
  markerRoot.add(disc);
  
  var sector, geometry, material;
  geometry = new THREE.CircleGeometry( radius, 32, 0, Math.PI*2/3);
  material = new THREE.MeshBasicMaterial();
  material.color = new THREE.Color("rgb(255,0,0)");
	sector = new THREE.Mesh( geometry, material );
  sector.rotation.x = -Math.PI/2;
  disc.add(sector);
  
  geometry = new THREE.CircleGeometry( radius, 32, Math.PI*2/3, Math.PI*2/3);
  material = new THREE.MeshBasicMaterial();
  material.color = new THREE.Color("rgb(0,255,0)");
  sector = new THREE.Mesh( geometry, material );
  sector.rotation.x = -Math.PI/2;
  disc.add(sector);
  
  geometry = new THREE.CircleGeometry( radius, 32, -Math.PI*2/3, Math.PI*2/3);
  material = new THREE.MeshBasicMaterial();
  material.color = new THREE.Color("rgb(0,0,255)");
  sector = new THREE.Mesh( geometry, material );
  sector.rotation.x = -Math.PI/2;
  disc.add(sector);
  
  geometry = new THREE.ConeGeometry( radius/10, radius/5, 32 );
	material = new THREE.MeshBasicMaterial( {color: 0xffff00} );
	cone = new THREE.Mesh( geometry, material );
  cone.rotation.x = Math.PI/2;
  cone.position.set(0, 0, -radius);
  markerRoot.add(cone); 
  
  
  // GridHelper
  //const gridHelper = new THREE.GridHelper( 1, 10 );
	//markerRoot.add( gridHelper );
		
	return markerRoot;
}	

var speed = 60;

function animate() {

	requestAnimationFrame(animate);
	stats.update();
	
  if (arMode) {
  
  	if ( arToolkitSource.ready === false )	return;
  	arToolkitContext.update( arToolkitSource.domElement );
    
  }
  else {
  	controls.update();
  }
	
  
	var dt = 0.2;
  
  var maxOmega = 2;
  if(isTurning)	omega = omega + 5*dt;  
	else			omega = omega - 0.15*dt;    
  omega = clamp(omega, 0, maxOmega);
  angle += omega*dt;
  disc.rotation.y = angle + Math.PI/2;
  
  angle = angle%(Math.PI*2);
  
  if(angle>Math.PI*2/3*2) {
  	$('#text').css ('color', 'red');
  }
  else if(angle>Math.PI*2/3) {
  	$('#text').css ('color', 'green');
  }
  else {
  	$('#text').css ('color', 'blue');
  }
	
	renderer.render(scene, camera);
  
}

function clamp (x, xLo, xHi) {

	if (x < xLo) return xLo;
  if (x > xHi) return xHi;
  else 				 return x;
  
}

function onResize() {

	arToolkitSource.onResizeElement();
  arToolkitSource.copyElementSizeTo(renderer.domElement);
  if( arToolkitContext.arController !== null ) {
    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
  }
  
}
</script>
</body>
